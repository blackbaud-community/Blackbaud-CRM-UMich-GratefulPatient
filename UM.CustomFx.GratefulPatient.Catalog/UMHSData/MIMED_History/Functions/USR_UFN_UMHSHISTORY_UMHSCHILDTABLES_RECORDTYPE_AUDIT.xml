<SQLFunctionSpec
	xmlns="bb_appfx_sqlfunction"
	xmlns:c="bb_appfx_commontypes" 
	ID="45d784cd-2d84-4afa-90bf-ec0b05b7a021"
	Name="USR_UFN_UMHSHISTORY_UMHSCHILDTABLES_RECORDTYPE_AUDIT"
	Description="USR_UFN_UMHSHISTORY_UMHSCHILDTABLES_RECORDTYPE_AUDIT"
	Author="UM Dev"
	DBFunctionName="USR_UFN_UMHSHISTORY_UMHSCHILDTABLES_RECORDTYPE_AUDIT"
	>

	<CreateFunctionSQL>
		<![CDATA[
CREATE function dbo.USR_UFN_UMHSHISTORY_UMHSCHILDTABLES_RECORDTYPE_AUDIT
			(
			--declare
				@UMHSID uniqueidentifier, --= --'42F78278-FF09-4559-AE47-04FBCEB57895',
				@UMHSDATEADDED datetime, --= null,
				@ACTIONTYPECODE tinyint, --= 0,
				@RECORDTYPECODE tinyint --= 0
			)
			--declare
			returns
			 @RESULTS table
			(
				RECORDID uniqueidentifier,
				AUDITDATE datetime,
				CHANGEDBYUSER nvarchar(128),
				PROCESS nvarchar(255),
				FIELD nvarchar(128),
				OLD nvarchar(4000),
				NEW nvarchar(4000),
				SEQUENCE int,
				ACTION nvarchar(8),
				CHANGEDBYAPP nvarchar(200)

			) as
			begin
				insert into @RESULTS					
					select 
						RECORDID,
						case when ACTION = 'Insert' then DATEADDED when ACTION = 'Update' then DATECHANGED else AUDITDATE end as [AUDITDATE],
						CHANGEDBYUSER,
						PROCESS,
						FIELD,
						OLD,
						NEW,
						40 as [SEQUENCE],
						ACTION,
						CHANGEDBYAPP
					from dbo.UFN_AUDIT_GETDETAILFORCHILDTABLE_BYFIELDLISTANDACTIONTYPE('PHONETYPECODEID,NUMBER,ISPRIMARY,INFOSOURCECODEID,DONOTCALL,
					DONOTCALLREASONCODEID,STARTDATE,ENDDATE,ISCONFIDENTIAL', 
					'USR_UMHS_PHONE', 'UMHSID', @UMHSID, @UMHSDATEADDED, 'Phone', '', @ACTIONTYPECODE)
					where @RECORDTYPECODE = 0 or @RECORDTYPECODE = 3
					union all
					select 
						RECORDID,
						case when ACTION = 'Insert' then DATEADDED when ACTION = 'Update' then DATECHANGED else AUDITDATE end as [AUDITDATE],
						CHANGEDBYUSER,
						PROCESS,
						FIELD,
						OLD,
						NEW,
						50 as [SEQUENCE],
						ACTION,
						CHANGEDBYAPP
					from dbo.UFN_AUDIT_GETDETAILFORCHILDTABLE_BYFIELDLISTANDACTIONTYPE('EMAILADDRESSTYPECODEID,EMAILADDRESS,
					ISPRIMARY,INFOSOURCECODEID, STARTDATE, ENDDATE', 'USR_UMHS_EMAILADDRESS', 'UMHSID', 
					@UMHSID, @UMHSDATEADDED, 'Email address', '', @ACTIONTYPECODE)
					where @RECORDTYPECODE = 0 or @RECORDTYPECODE = 5
					union all
					select 
						RECORDID,
						case when ACTION = 'Insert' then DATEADDED when ACTION = 'Update' then DATECHANGED else AUDITDATE end as [AUDITDATE],
						CHANGEDBYUSER,
						PROCESS,
						FIELD,
						OLD,
						NEW,
						60 as [SEQUENCE],
						ACTION,
						CHANGEDBYAPP
					from dbo.UFN_AUDIT_GETDETAILFORCHILDTABLE_BYFIELDLISTANDACTIONTYPE('ADDRESSTYPECODEID,COUNTRYID,STATEID,
					ADDRESSBLOCK,CITY,POSTCODE,ISPRIMARY,DONOTMAIL,HISTORICALSTARTDATE, HISTORICALENDDATE, 
					ISCONFIDENTIAL', 'USR_UMHS_ADDRESS', 'UMHSID', @UMHSID, @UMHSDATEADDED, 
					'Address', '', @ACTIONTYPECODE)
					where @RECORDTYPECODE = 0 or @RECORDTYPECODE = 4
					union all
					select 
						RECORDID,
						case when ACTION = 'Insert' then DATEADDED when ACTION = 'Update' then DATECHANGED else AUDITDATE end as [AUDITDATE],
						CHANGEDBYUSER,
						PROCESS,
						FIELD,
						OLD,
						NEW,
						70 as [SEQUENCE],
						ACTION,
						CHANGEDBYAPP
						
					from dbo.UFN_AUDIT_GETDETAILFORCHILDTABLE_BYFIELDLISTANDACTIONTYPE('INTERESTTYPECODEID,INTERESTLEVELCODE,DISCOVEREDBYID,STARTDATE,ENDDATE,COMMENT', 
					'USR_UMHS_INTEREST', 'UMHSID', @UMHSID, @UMHSDATEADDED, 'Interest', '', @ACTIONTYPECODE)					
					where @RECORDTYPECODE = 0 or @RECORDTYPECODE = 6					
					union all
					-------Interaction------------
					select 
						RECORDID,
						case when ACTION = 'Insert' then DATEADDED when ACTION = 'Update' then DATECHANGED else AUDITDATE end as [AUDITDATE],
						CHANGEDBYUSER,
						PROCESS,
						FIELD,
						OLD,
						NEW,
						70 as [SEQUENCE],
						ACTION,
						CHANGEDBYAPP
					from dbo.UFN_AUDIT_GETDETAILFORCHILDTABLE_BYFIELDLISTANDACTIONTYPE('FUNDRAISERID,SUMMARY,CONTACTMETHODCODEID', 
					'USR_UMHS_INTERACTION', 'UMHSID', @UMHSID, @UMHSDATEADDED, 'Interaction', '', @ACTIONTYPECODE)
					where @RECORDTYPECODE = 0 or @RECORDTYPECODE = 7					
					--union all
					----Affiliation--
					--select 
					--	RECORDID,
					--	case when ACTION = 'Insert' then DATEADDED when ACTION = 'Update' then DATECHANGED else AUDITDATE end as [AUDITDATE],
					--	CHANGEDBYUSER,
					--	PROCESS,
					--	FIELD,
					--	OLD,
					--	NEW,
					--	70 as [SEQUENCE],
					--	ACTION,
					--	CHANGEDBYAPP
					--from dbo.UFN_AUDIT_GETDETAILFORCHILDTABLE_BYFIELDLISTANDACTIONTYPE('AFFILIATIONBASENAMECODEID,DEPARTMENTID,SUBDEPARTMENTID,STARTDATE,ENDDATE,COMMENTS', 
					--'USR_UMHS_AFFILIATION', 'UMHSID', @UMHSID, @UMHSDATEADDED, 'Affiliation', '', @ACTIONTYPECODE)
					--where @RECORDTYPECODE = 0 or @RECORDTYPECODE = 8					
					--Team--
					union all
					select 
						RECORDID,
						case when ACTION = 'Insert' then DATEADDED when ACTION = 'Update' then DATECHANGED else AUDITDATE end as [AUDITDATE],
						CHANGEDBYUSER,
						PROCESS,
						FIELD,
						OLD,
						NEW,
						70 as [SEQUENCE],
						ACTION,
						CHANGEDBYAPP
					from dbo.UFN_AUDIT_GETDETAILFORCHILDTABLE_BYFIELDLISTANDACTIONTYPE('TEAMMEMBERID,TEAMROLECODEID,STARTDATE,ENDDATE', 
					'USR_UMHS_TEAM', 'UMHSID', @UMHSID, @UMHSDATEADDED, 'Team', '', @ACTIONTYPECODE)
					where @RECORDTYPECODE = 0 or @RECORDTYPECODE = 8					
					union all
					-----Note------------------------
					select 
						RECORDID,
						case when ACTION = 'Insert' then DATEADDED when ACTION = 'Update' then DATECHANGED else AUDITDATE end as [AUDITDATE],
						CHANGEDBYUSER,
						PROCESS,
						FIELD,
						OLD,
						NEW,
						110 as [SEQUENCE],
						ACTION,
						CHANGEDBYAPP
					from dbo.UFN_AUDIT_GETDETAILFORCHILDTABLE_BYFIELDLISTANDACTIONTYPE('DATEENTERED,TITLE,AUTHORID,TEXTNOTE,UMHSNOTETYPECODEID', 
					'USR_UMHS_NOTE', 'UMHSID', @UMHSID, @UMHSDATEADDED, 'Note', '', @ACTIONTYPECODE)
					where @RECORDTYPECODE = 0 or @RECORDTYPECODE = 12
					-----Relationship-----			
					union all
					select 
						RECORDID,
						case when ACTION = 'Insert' then DATEADDED when ACTION = 'Update' then DATECHANGED else AUDITDATE end as [AUDITDATE],
						CHANGEDBYUSER,
						PROCESS,
						FIELD,
						OLD,
						NEW,
						160 as [SEQUENCE],
						ACTION,
						CHANGEDBYAPP
					from dbo.UFN_AUDIT_GETDETAILFORCHILDTABLE_BYFIELDLISTANDACTIONTYPE('RECIPROCALTYPECODEID,RELATIONSHIPTYPECODEID,
					RECIPROCALTYPECODEID,STARTDATE,ENDDATE,ISSPOUSE,ISPRIMARYBUSINESS,ISCONTACT,CONTACTTYPECODEID,
					ISPRIMARYCONTACT', 'USR_UMHS_RELATIONSHIP', 'UMHSID', @UMHSID, @UMHSDATEADDED, 'Relationship', '', @ACTIONTYPECODE)
					where @RECORDTYPECODE = 0 or @RECORDTYPECODE = 15
					
				return;
			end

		
		]]>
	</CreateFunctionSQL>

</SQLFunctionSpec>
