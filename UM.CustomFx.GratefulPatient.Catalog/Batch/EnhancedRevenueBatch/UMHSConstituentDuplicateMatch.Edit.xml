<EditDataFormTemplateSpec xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:d1p1="bb_appfx_commontypes" xmlns="bb_appfx_editdataformtemplate" ID="0cb68a8e-3cff-461d-98dd-8e52be67e047" Name="Constituent Duplicate Match Edit Data Form" Description="Loads and saves detailed information about the match record being selected." Author="Blackbaud Product Development" RecordType="Constituent" DataFormInstanceID="749d30ac-480c-47fb-9476-5527b30d801b" d1p1:SecurityUIFolder="Constituent" OwnerIDMapperID="00000000-0000-0000-0000-000000000000">
  <d1p1:InstalledProductList>
    <d1p1:InstalledProduct ID="3117d2c8-7f46-42f2-abeb-b654f2f63046" />
    <d1p1:InstalledProduct ID="42c15648-749e-4859-a56d-3a6474814cc7" />
  </d1p1:InstalledProductList>
  <ResourceFile AssemblyName="Blackbaud.AppFx.Constituent.Catalog.dll" ClassName="Blackbaud.AppFx.Constituent.Catalog.ConstituentDuplicateMatch.Edit" />
  <SPDataForm>
    <LoadImplementation SPName="USP_DATAFORMTEMPLATE_EDITLOAD_CONSTITUENTDUPLICATEMATCH">
      <d1p1:CreateProcedureSQL>
<![CDATA[
CREATE PROCEDURE DBO.USP_DATAFORMTEMPLATE_EDITLOAD_CONSTITUENTDUPLICATEMATCH (@ID                                 UNIQUEIDENTIFIER,
                                                                              @DATALOADED                         BIT = 0 OUTPUT,
                                                                              @TSLONG                             BIGINT = 0 OUTPUT,
                                                                              @LOOKUPID                           NVARCHAR(50) = NULL OUTPUT,
                                                                              @FIRSTNAME                          NVARCHAR(50) = NULL OUTPUT,
                                                                              @MIDDLENAME                         NVARCHAR(50) = NULL OUTPUT,
                                                                              @LASTNAME                           NVARCHAR(100) = NULL OUTPUT,-- also used as OsRGANIZATIONNAME
                                                                              @SUFFIXCODEID                       UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @TITLECODEID                        UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @MAIDENNAME                         NVARCHAR(100) = NULL OUTPUT,
                                                                              @NICKNAME                           NVARCHAR(50) = NULL OUTPUT,
                                                                              @GENDERCODE                         TINYINT = NULL OUTPUT,
                                                                              @BIRTHDATE                          DBO.UDT_FUZZYDATE = NULL OUTPUT,
                                                                              @ADDRESSID                          UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @ADDRESSTYPECODEID                  UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @ADDRESS_ADDRESSBLOCK               NVARCHAR(150) = NULL OUTPUT,
                                                                              @ADDRESS_CITY                       NVARCHAR(50) = NULL OUTPUT,
                                                                              @ADDRESS_STATEID                    UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @ADDRESS_POSTCODE                   NVARCHAR(12) = NULL OUTPUT,
                                                                              @ADDRESS_COUNTRYID                  UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @PHONEID                            UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @PHONETYPECODEID                    UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @PHONENUMBER                        NVARCHAR(100) = NULL OUTPUT,
                                                                              @EMAILID                            UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @EMAILADDRESSTYPECODEID             UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @EMAILADDRESS                       DBO.UDT_EMAILADDRESS = NULL OUTPUT,
                                                                              @CREATEDON                          DATETIME = NULL OUTPUT,
                                                                              @DATECHANGED                        DATETIME = NULL OUTPUT,
                                                                              @ADDRESSES                          XML = NULL OUTPUT,
                                                                              @PHONES                             XML = NULL OUTPUT,
                                                                              @EMAILS                             XML = NULL OUTPUT,
                                                                              @SPOUSENAME                         NVARCHAR(154) = NULL OUTPUT,
                                                                              @SPOUSELOOKUPID                     NVARCHAR(50) = NULL OUTPUT,
                                                                              @SPOUSESTARTDATE                    DATETIME = NULL OUTPUT,
                                                                              @SPOUSEENDDATE                      DATETIME = NULL OUTPUT,
                                                                              @HOUSEHOLDNAME                      NVARCHAR(154) = NULL OUTPUT,
                                                                              @HOUSEHOLDLOOKUPID                  NVARCHAR(50) = NULL OUTPUT,
                                                                              @BUSINESSNAME                       NVARCHAR(154) = NULL OUTPUT,
                                                                              @BUSINESSLOOKUPID                   NVARCHAR(50) = NULL OUTPUT,
                                                                              @CONSTITUENTACTION                  TINYINT = NULL OUTPUT,
                                                                              @ADDRESSACTION                      TINYINT = NULL OUTPUT,
                                                                              @EMAILACTION                        TINYINT = NULL OUTPUT,
                                                                              @PHONEACTION                        TINYINT = NULL OUTPUT,
                                                                              @ISORGANIZATION                     BIT = NULL OUTPUT,
                                                                              @INDUSTRYCODEID                     UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @NUMEMPLOYEES                       INT = NULL OUTPUT,
                                                                              @NUMSUBSIDIARIES                    INT = NULL OUTPUT,
                                                                              @DECEASED                           BIT = NULL OUTPUT,
                                                                              @DECEASEDDATE                       DBO.UDT_FUZZYDATE = NULL OUTPUT,
                                                                              @GIVESANONYMOUSLY                   BIT = NULL OUTPUT,
                                                                              @MARITALSTATUSCODEID                UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @WEBADDRESS                         DBO.UDT_WEBADDRESS = NULL OUTPUT,
                                                                              @ADDRESSHISTORICALSTARTDATE         DATE = NULL OUTPUT,
                                                                              @ADDRESSHISTORICALENDDATE           DATE = NULL OUTPUT,
                                                                              @ADDRESSDONOTMAIL                   BIT = NULL OUTPUT,
                                                                              @ADDRESSDONOTMAILREASONCODEID       UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @ADDRESSSTARTDATE                   DBO.UDT_MONTHDAY = NULL OUTPUT,
                                                                              @ADDRESSENDDATE                     DBO.UDT_MONTHDAY = NULL OUTPUT,
                                                                              @ADDRESSDPC                         NVARCHAR(MAX) = NULL OUTPUT,
                                                                              @ADDRESSCART                        NVARCHAR(MAX) = NULL OUTPUT,
                                                                              @ADDRESSLOT                         NVARCHAR(5) = NULL OUTPUT,
                                                                              @ADDRESSINFOSOURCECODEID            UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @ADDRESSINFOSOURCECOMMENTS          NVARCHAR(256) = NULL OUTPUT,
                                                                              @ADDRESSCOUNTYCODEID                UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @ADDRESSREGIONCODEID                UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @ADDRESSCONGRESSIONALDISTRICTCODEID UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @ADDRESSSTATEHOUSEDISTRICTCODEID    UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @ADDRESSSTATESENATEDISTRICTCODEID   UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @ADDRESSLOCALPRECINCTCODEID         UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @ADDRESSCERTIFICATIONDATA           INT = NULL OUTPUT,
                                                                              @ADDRESSLASTVALIDATIONATTEMPTDATE   DATE = NULL OUTPUT,
                                                                              @ADDRESSOMITFROMVALIDATION          BIT = NULL OUTPUT,
                                                                              @ADDRESSVALIDATIONMESSAGE           NVARCHAR(200) = NULL OUTPUT,
                                                                              @PHONEDONOTCALL                     BIT = NULL OUTPUT,
                                                                              @PHONESTARTTIME                     DBO.UDT_HOURMINUTE = NULL OUTPUT,
                                                                              @PHONEENDTIME                       DBO.UDT_HOURMINUTE = NULL OUTPUT,
                                                                              @PHONEINFOSOURCECODEID              UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @PHONECOUNTRYID                     UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @PHONESTARTDATE                     DATE = NULL OUTPUT,
                                                                              @PHONEENDDATE                       DATE = NULL OUTPUT,
                                                                              @PHONESEASONALSTARTDATE             DBO.UDT_MONTHDAY = NULL OUTPUT,
                                                                              @PHONESEASONALENDDATE               DBO.UDT_MONTHDAY = NULL OUTPUT,
                                                                              @EMAILADDRESSDONOTEMAIL             BIT = NULL OUTPUT,
                                                                              @EMAILADDRESSINFOSOURCECODEID       UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @EMAILADDRESSSTARTDATE              DATE = NULL OUTPUT,
                                                                              @EMAILADDRESSENDDATE                DATE = NULL OUTPUT,
                                                                              @DEFAULTCOUNTRYID                   UNIQUEIDENTIFIER = NULL OUTPUT,
                                                                              @CONSTITUENCIES                     XML = NULL OUTPUT)
AS
    SET NOCOUNT ON;
    SET @DATALOADED = 0;
    SET @TSLONG = 0;

    DECLARE @ISGROUP BIT;

    --CONSTIT FIELDS
    SELECT @DATALOADED = 1,
           @ISORGANIZATION = CONSTITUENT.ISORGANIZATION,
           @ISGROUP = CONSTITUENT.ISGROUP,
           @FIRSTNAME = CONSTITUENT.FIRSTNAME,
           @MIDDLENAME = CONSTITUENT.MIDDLENAME,
           @LASTNAME = CASE CONSTITUENT.ISORGANIZATION WHEN 1 THEN CONSTITUENT.KEYNAMEPREFIX
                                   + CASE CONSTITUENT.KEYNAMEPREFIX WHEN '' THEN ''
                                     ELSE '\'
                                     END
                                   + CONSTITUENT.KEYNAME
                       ELSE CONSTITUENT.KEYNAME
                       END,
           @SUFFIXCODEID = CONSTITUENT.SUFFIXCODEID,
           @TITLECODEID = CONSTITUENT.TITLECODEID,
           @MAIDENNAME = CONSTITUENT.MAIDENNAME,
           @NICKNAME = CONSTITUENT.NICKNAME,
           @GENDERCODE = CONSTITUENT.GENDERCODE,
           @BIRTHDATE = CONSTITUENT.BIRTHDATE,
           @LOOKUPID = CONSTITUENT.LOOKUPID,
           @CREATEDON = CONSTITUENT.DATEADDED,
           @DATECHANGED = CONSTITUENT.DATECHANGED,
           @TSLONG = CONSTITUENT.TSLONG,
           @INDUSTRYCODEID = ORGANIZATIONDATA.INDUSTRYCODEID,
           @NUMEMPLOYEES = COALESCE(ORGANIZATIONDATA.NUMEMPLOYEES, 0),
           @NUMSUBSIDIARIES = COALESCE(ORGANIZATIONDATA.NUMSUBSIDIARIES, 0),
           @MARITALSTATUSCODEID = MARITALSTATUSCODEID,
           @DECEASED = DBO.UFN_CONSTITUENT_ISDECEASED(@ID),
           @DECEASEDDATE = (SELECT DECEASEDDATE
                            FROM   DBO.DECEASEDCONSTITUENT
                            WHERE  ID = @ID),
           @WEBADDRESS = WEBADDRESS,
           @GIVESANONYMOUSLY = GIVESANONYMOUSLY
    FROM   DBO.CONSTITUENT
           LEFT JOIN DBO.ORGANIZATIONDATA ON DBO.CONSTITUENT.ID = DBO.ORGANIZATIONDATA.ID
    WHERE  CONSTITUENT.ID = @ID;

    --EMAIL
    DECLARE @EMAILTABLE TABLE (
      EMAILADDRESS           DBO.UDT_EMAILADDRESS,
      EMAILADDRESSID         UNIQUEIDENTIFIER,
      EMAILADDRESSTYPECODEID UNIQUEIDENTIFIER,
      ISPRIMARY              BIT,
      STARTDATE              DATETIME,
      ENDDATE                DATETIME,
      INFOSOURCECODEID       UNIQUEIDENTIFIER,
      DONOTEMAIL             BIT,
      LASTUPDATED            DATE
    );

    INSERT INTO @EMAILTABLE
                (EMAILADDRESS,
                 EMAILADDRESSID,
                 EMAILADDRESSTYPECODEID,
                 ISPRIMARY,
                 STARTDATE,
                 ENDDATE,
                 INFOSOURCECODEID,
                 DONOTEMAIL,
                 LASTUPDATED)
    SELECT EMAILADDRESS,
           ID,
           EMAILADDRESSTYPECODEID,
           ISPRIMARY,
           STARTDATE,
           ENDDATE,
           INFOSOURCECODEID,
           DONOTEMAIL,
           DATECHANGED
    FROM   DBO.EMAILADDRESS
    WHERE  EMAILADDRESS.CONSTITUENTID = @ID;

    SELECT @EMAILID = EMAILADDRESSID,
           @EMAILADDRESSTYPECODEID = EMAILADDRESSTYPECODEID,
           @EMAILADDRESS = EMAILADDRESS,
           @EMAILADDRESSSTARTDATE = STARTDATE,
           @EMAILADDRESSENDDATE = ENDDATE,
           @EMAILADDRESSINFOSOURCECODEID = INFOSOURCECODEID,
           @EMAILADDRESSDONOTEMAIL = DONOTEMAIL
    FROM   @EMAILTABLE
    WHERE  ISPRIMARY = 1;

    SET @EMAILS = (SELECT EMAILADDRESSID,
                          EMAILADDRESSTYPECODEID,
                          EMAILADDRESS,
                          STARTDATE,
                          ENDDATE,
                          ISPRIMARY,
                          LASTUPDATED
                   FROM   @EMAILTABLE
                   ORDER  BY ISPRIMARY DESC
                   FOR XML RAW('ITEM'), TYPE, ELEMENTS, ROOT('EMAILS'), BINARY BASE64);

    --PHONE
    DECLARE @PHONETABLE TABLE (
      PHONENUMBER       NVARCHAR(100),
      PHONEID           UNIQUEIDENTIFIER,
      PHONETYPECODEID   UNIQUEIDENTIFIER,
      ISPRIMARY         BIT,
      STARTDATE         DATETIME,
      ENDDATE           DATETIME,
      DONOTCALL         BIT,
      COUNTRYID         UNIQUEIDENTIFIER,
      STARTTIME         DBO.UDT_HOURMINUTE,
      ENDTIME           DBO.UDT_HOURMINUTE,
      SEASONALSTARTDATE DBO.UDT_MONTHDAY,
      SEASONALENDDATE   DBO.UDT_MONTHDAY,
      INFOSOURCECODEID  UNIQUEIDENTIFIER,
      LASTUPDATED       DATE
    );

    INSERT INTO @PHONETABLE
                (PHONENUMBER,
                 PHONEID,
                 PHONETYPECODEID,
                 ISPRIMARY,
                 STARTDATE,
                 ENDDATE,
                 DONOTCALL,
                 COUNTRYID,
                 STARTTIME,
                 ENDTIME,
                 SEASONALSTARTDATE,
                 SEASONALENDDATE,
                 INFOSOURCECODEID,
                 LASTUPDATED)
    SELECT PHONE.NUMBER,
           PHONE.ID,
           PHONE.PHONETYPECODEID,
           PHONE.ISPRIMARY,
           PHONE.STARTDATE,
           PHONE.ENDDATE,
           DONOTCALL,
           COUNTRYID,
           STARTTIME,
           ENDTIME,
           SEASONALSTARTDATE,
           SEASONALENDDATE,
           INFOSOURCECODEID,
           DATECHANGED
    FROM   DBO.PHONE
    WHERE  PHONE.CONSTITUENTID = @ID;

    -- get primary phone
    SELECT @PHONEID = PHONEID,
           @PHONETYPECODEID = PHONETYPECODEID,
           @PHONENUMBER = PHONENUMBER,
           @PHONEDONOTCALL = DONOTCALL,
           @PHONECOUNTRYID = COUNTRYID,
           @PHONESEASONALSTARTDATE = SEASONALSTARTDATE,
           @PHONESEASONALENDDATE = SEASONALENDDATE,
           @PHONESTARTDATE = STARTDATE,
           @PHONEENDDATE = ENDDATE,
           @PHONESTARTTIME = STARTTIME,
           @PHONEENDTIME = ENDTIME,
           @PHONEINFOSOURCECODEID = INFOSOURCECODEID
    FROM   @PHONETABLE
    WHERE  ISPRIMARY = 1;

    SET @PHONES = (SELECT PHONEID,
                          PHONETYPECODEID,
                          PHONENUMBER,
                          STARTDATE,
                          ENDDATE,
                          ISPRIMARY,
                          LASTUPDATED
                   FROM   @PHONETABLE
                   ORDER  BY ISPRIMARY DESC
                   FOR XML RAW('ITEM'), TYPE, ELEMENTS, ROOT('PHONES'), BINARY BASE64);

    --ADDRESS
    DECLARE @ADDRESSTABLE TABLE (
      ADDRESSID                   UNIQUEIDENTIFIER,
      ADDRESSTYPECODEID           UNIQUEIDENTIFIER,
      ADDRESSBLOCK                NVARCHAR(150),
      CITY                        NVARCHAR(50),
      STATEID                     UNIQUEIDENTIFIER,
      POSTCODE                    NVARCHAR(12),
      ISPRIMARY                   BIT,
      STARTDATE                   DBO.UDT_MONTHDAY,
      ENDDATE                     DBO.UDT_MONTHDAY,
      COUNTRYID                   UNIQUEIDENTIFIER,
      HISTORICALSTARTDATE         DATE,
      HISTORICALENDDATE           DATE,
      DONOTMAIL                   BIT,
      DONOTMAILREASONCODEID       UNIQUEIDENTIFIER,
      DPC                         NVARCHAR(MAX),
      CART                        NVARCHAR(MAX),
      LOT                         NVARCHAR(5),
      INFOSOURCECODEID            UNIQUEIDENTIFIER,
      INFOSOURCECOMMENTS          NVARCHAR(256),
      COUNTYCODEID                UNIQUEIDENTIFIER,
      REGIONCODEID                UNIQUEIDENTIFIER,
      CONGRESSIONALDISTRICTCODEID UNIQUEIDENTIFIER,
      STATEHOUSEDISTRICTCODEID    UNIQUEIDENTIFIER,
      STATESENATEDISTRICTCODEID   UNIQUEIDENTIFIER,
      LOCALPRECINCTCODEID         UNIQUEIDENTIFIER,
      CERTIFICATIONDATA           INT,
      LASTVALIDATIONATTEMPTDATE   DATE,
      OMITFROMVALIDATION          BIT,
      VALIDATIONMESSAGE           NVARCHAR(200),
      LASTUPDATED                 DATE
    );

    INSERT INTO @ADDRESSTABLE
                (ADDRESSID,
                 ADDRESSTYPECODEID,
                 ADDRESSBLOCK,
                 CITY,
                 STATEID,
                 POSTCODE,
                 ISPRIMARY,
                 STARTDATE,
                 ENDDATE,
                 COUNTRYID,
                 HISTORICALSTARTDATE,
                 HISTORICALENDDATE,
                 DONOTMAIL,
                 DONOTMAILREASONCODEID,
                 DPC,
                 CART,
                 LOT,
                 INFOSOURCECODEID,
                 INFOSOURCECOMMENTS,
                 COUNTYCODEID,
                 REGIONCODEID,
                 CONGRESSIONALDISTRICTCODEID,
                 STATEHOUSEDISTRICTCODEID,
                 STATESENATEDISTRICTCODEID,
                 LOCALPRECINCTCODEID,
                 CERTIFICATIONDATA,
                 LASTVALIDATIONATTEMPTDATE,
                 OMITFROMVALIDATION,
                 VALIDATIONMESSAGE,
                 LASTUPDATED)
    SELECT ADDRESS.ID,
           ADDRESS.ADDRESSTYPECODEID,
           ADDRESS.ADDRESSBLOCK,
           ADDRESS.CITY,
           ADDRESS.STATEID,
           ADDRESS.POSTCODE,
           ISPRIMARY,
           STARTDATE,
           ENDDATE,
           COUNTRYID,
           HISTORICALSTARTDATE,
           HISTORICALENDDATE,
           DONOTMAIL,
           DONOTMAILREASONCODEID,
           DPC,
           CART,
           LOT,
           INFOSOURCECODEID,
           INFOSOURCECOMMENTS,
           COUNTYCODEID,
           REGIONCODEID,
           CONGRESSIONALDISTRICTCODEID,
           STATEHOUSEDISTRICTCODEID,
           STATESENATEDISTRICTCODEID,
           LOCALPRECINCTCODEID,
           CERTIFICATIONDATA,
           LASTVALIDATIONATTEMPTDATE,
           OMITFROMVALIDATION,
           VALIDATIONMESSAGE,
           ADDRESS.DATECHANGED
    FROM   DBO.ADDRESS
           LEFT JOIN DBO.ADDRESSVALIDATIONUPDATE ON ADDRESSVALIDATIONUPDATE.ID = ADDRESS.ID
    WHERE  ADDRESS.CONSTITUENTID = @ID;

    -- get primary address
    SELECT @ADDRESSID = ADDRESSID,
           @ADDRESSTYPECODEID = ADDRESSTYPECODEID,
           @ADDRESS_ADDRESSBLOCK = ADDRESSBLOCK,
           @ADDRESS_CITY = CITY,
           @ADDRESS_STATEID = STATEID,
           @ADDRESS_POSTCODE = POSTCODE,
           @ADDRESS_COUNTRYID = COUNTRYID,
           @ADDRESSHISTORICALSTARTDATE = HISTORICALSTARTDATE,
           @ADDRESSHISTORICALENDDATE = HISTORICALENDDATE,
           @ADDRESSDONOTMAIL = DONOTMAIL,
           @ADDRESSDONOTMAILREASONCODEID = DONOTMAILREASONCODEID,
           @ADDRESSSTARTDATE = STARTDATE,
           @ADDRESSENDDATE = ENDDATE,
           @ADDRESSDPC = DPC,
           @ADDRESSCART = CART,
           @ADDRESSLOT = LOT,
           @ADDRESSINFOSOURCECODEID = INFOSOURCECODEID,
           @ADDRESSINFOSOURCECOMMENTS = INFOSOURCECOMMENTS,
           @ADDRESSCOUNTYCODEID = COUNTYCODEID,
           @ADDRESSREGIONCODEID = REGIONCODEID,
           @ADDRESSCONGRESSIONALDISTRICTCODEID = CONGRESSIONALDISTRICTCODEID,
           @ADDRESSSTATEHOUSEDISTRICTCODEID = STATEHOUSEDISTRICTCODEID,
           @ADDRESSSTATESENATEDISTRICTCODEID = STATESENATEDISTRICTCODEID,
           @ADDRESSLOCALPRECINCTCODEID = LOCALPRECINCTCODEID,
           @ADDRESSCERTIFICATIONDATA = CERTIFICATIONDATA,
           @ADDRESSLASTVALIDATIONATTEMPTDATE = LASTVALIDATIONATTEMPTDATE,
           @ADDRESSOMITFROMVALIDATION = OMITFROMVALIDATION,
           @ADDRESSVALIDATIONMESSAGE = VALIDATIONMESSAGE
    FROM   @ADDRESSTABLE
    WHERE  ISPRIMARY = 1;

    SET @ADDRESSES = (SELECT ADDRESSID,
                             ADDRESSTYPECODEID,
                             ADDRESSBLOCK,
                             CITY,
                             STATEID,
                             POSTCODE,
                             STARTDATE,
                             ENDDATE,
                             ISPRIMARY,
                             COUNTRYID,
                             DBO.UFN_BUILDFULLADDRESS(ADDRESSID, ADDRESSBLOCK, CITY, STATEID, POSTCODE, COUNTRYID) AS FULLADDRESS,
                             LASTUPDATED,
                             HISTORICALSTARTDATE,
                             HISTORICALENDDATE
                      FROM   @ADDRESSTABLE
                      ORDER  BY ISPRIMARY DESC
                      FOR XML RAW('ITEM'), TYPE, ELEMENTS, ROOT('ADDRESSES'), BINARY BASE64);

    -- spouse information
    SELECT @SPOUSENAME = CONSTITUENT.NAME,
           @SPOUSELOOKUPID = CONSTITUENT.LOOKUPID,
           @SPOUSESTARTDATE = RELATIONSHIP.STARTDATE,
           @SPOUSEENDDATE = RELATIONSHIP.ENDDATE
    FROM   DBO.RELATIONSHIP
           INNER JOIN DBO.CONSTITUENT ON RELATIONSHIP.RECIPROCALCONSTITUENTID = CONSTITUENT.ID
    WHERE  RELATIONSHIP.RELATIONSHIPCONSTITUENTID = @ID
           AND RELATIONSHIP.ISSPOUSE = 1;

    -- household information
    IF @ISORGANIZATION = 0
       AND @ISGROUP = 0
      SELECT TOP (1) @HOUSEHOLDNAME = CG.NAME,
                     @HOUSEHOLDLOOKUPID = CG.LOOKUPID
      FROM   DBO.GROUPMEMBER AS GM
             JOIN DBO.CONSTITUENT AS CG ON GM.GROUPID = CG.ID
             JOIN DBO.GROUPDATA AS GD ON GD.ID = CG.ID
      WHERE  GM.MEMBERID = @ID
             AND DBO.UFN_GROUPMEMBER_ISCURRENTMEMBER(GM.ID) = 1
             AND GD.GROUPTYPECODE = 0;

    -- get primary business
    IF @ISORGANIZATION = 0
       AND @ISGROUP = 0
      SELECT @BUSINESSNAME = [ORG].KEYNAME,
             @BUSINESSLOOKUPID = [ORG].LOOKUPID
      FROM   DBO.RELATIONSHIP
             INNER JOIN DBO.CONSTITUENT AS [ORG] ON [ORG].ID = RELATIONSHIP.RECIPROCALCONSTITUENTID
      WHERE  RELATIONSHIP.RELATIONSHIPCONSTITUENTID = @ID
             AND RELATIONSHIP.ISPRIMARYBUSINESS = 1;

    SELECT @DEFAULTCOUNTRYID = DEFAULTCOUNTRYID
    FROM   DBO.INTERNATIONALIZATIONINFO

    -- constituencies
    SELECT @CONSTITUENCIES = (SELECT CONSTITUENCYCODEID     AS '@CONSTITUENCYCODEID',
                                     ORIGINALCONSTITUENCYID AS '@ORIGINALCONSTITUENCYID',
                                     DATEFROM               AS '@DATEFROM',
                                     DATETO                 AS '@DATETO'
                              FROM   DBO.UFN_CONSTITUENT_GETCONSTITUENCIES_FORUPDATEBATCH(@ID)
                              FOR XML PATH('ITEM'), TYPE, ELEMENTS, ROOT('CONSTITUENCIES'), BINARY BASE64)

    RETURN 0; 

]]>

      </d1p1:CreateProcedureSQL>
    </LoadImplementation>
    <SaveImplementation SPName="USP_DATAFORMTEMPLATE_EDIT_CONSTITUENTDUPLICATEMATCH_3">
      <d1p1:CreateProcedureSQL>
<![CDATA[
CREATE PROCEDURE DBO.USP_DATAFORMTEMPLATE_EDIT_CONSTITUENTDUPLICATEMATCH_3 (@ID                                 UNIQUEIDENTIFIER,
                                                                            @CHANGEAGENTID                      UNIQUEIDENTIFIER = NULL,
                                                                            @LOOKUPID                           NVARCHAR(50),
                                                                            @FIRSTNAME                          NVARCHAR(50),
                                                                            @MIDDLENAME                         NVARCHAR(50),
                                                                            @LASTNAME                           NVARCHAR(100),
                                                                            @SUFFIXCODEID                       UNIQUEIDENTIFIER,
                                                                            @TITLECODEID                        UNIQUEIDENTIFIER,
                                                                            @MAIDENNAME                         NVARCHAR(100),
                                                                            @NICKNAME                           NVARCHAR(50),
                                                                            @GENDERCODE                         TINYINT,
                                                                            @BIRTHDATE                          DBO.UDT_FUZZYDATE,
                                                                            @ADDRESSID                          UNIQUEIDENTIFIER,
                                                                            @ADDRESSTYPECODEID                  UNIQUEIDENTIFIER,
                                                                            @ADDRESS_ADDRESSBLOCK               NVARCHAR(150),
                                                                            @ADDRESS_CITY                       NVARCHAR(50),
                                                                            @ADDRESS_STATEID                    UNIQUEIDENTIFIER,
                                                                            @ADDRESS_POSTCODE                   NVARCHAR(12),
                                                                            @ADDRESS_COUNTRYID                  UNIQUEIDENTIFIER,
                                                                            @PHONEID                            UNIQUEIDENTIFIER,
                                                                            @PHONETYPECODEID                    UNIQUEIDENTIFIER,
                                                                            @PHONENUMBER                        NVARCHAR(100),
                                                                            @EMAILID                            UNIQUEIDENTIFIER,
                                                                            @EMAILADDRESSTYPECODEID             UNIQUEIDENTIFIER,
                                                                            @EMAILADDRESS                       DBO.UDT_EMAILADDRESS,
                                                                            @CREATEDON                          DATETIME,
                                                                            @DATECHANGED                        DATETIME,
                                                                            @ADDRESSES                          XML,
                                                                            @PHONES                             XML,
                                                                            @EMAILS                             XML,
                                                                            @SPOUSENAME                         NVARCHAR(154),
                                                                            @SPOUSELOOKUPID                     NVARCHAR(50),
                                                                            @SPOUSESTARTDATE                    DATETIME,
                                                                            @SPOUSEENDDATE                      DATETIME,
                                                                            @HOUSEHOLDNAME                      NVARCHAR(154),
                                                                            @HOUSEHOLDLOOKUPID                  NVARCHAR(50),
                                                                            @BUSINESSNAME                       NVARCHAR(154),
                                                                            @BUSINESSLOOKUPID                   NVARCHAR(50),
                                                                            @CONSTITUENTACTION                  TINYINT,
                                                                            @ADDRESSACTION                      TINYINT,
                                                                            @EMAILACTION                        TINYINT,
                                                                            @PHONEACTION                        TINYINT,
                                                                            @ISORGANIZATION                     BIT,
                                                                            @INDUSTRYCODEID                     UNIQUEIDENTIFIER,
                                                                            @NUMEMPLOYEES                       INT,
                                                                            @NUMSUBSIDIARIES                    INT,
                                                                            @DECEASED                           BIT,
                                                                            @DECEASEDDATE                       DBO.UDT_FUZZYDATE,
                                                                            @GIVESANONYMOUSLY                   BIT,
                                                                            @MARITALSTATUSCODEID                UNIQUEIDENTIFIER,
                                                                            @WEBADDRESS                         DBO.UDT_WEBADDRESS,
                                                                            @ADDRESSHISTORICALSTARTDATE         DATE,
                                                                            @ADDRESSHISTORICALENDDATE           DATE,
                                                                            @ADDRESSDONOTMAIL                   BIT,
                                                                            @ADDRESSDONOTMAILREASONCODEID       UNIQUEIDENTIFIER,
                                                                            @ADDRESSSTARTDATE                   DBO.UDT_MONTHDAY,
                                                                            @ADDRESSENDDATE                     DBO.UDT_MONTHDAY,
                                                                            @ADDRESSDPC                         NVARCHAR(MAX),
                                                                            @ADDRESSCART                        NVARCHAR(MAX),
                                                                            @ADDRESSLOT                         NVARCHAR(5),
                                                                            @ADDRESSINFOSOURCECODEID            UNIQUEIDENTIFIER,
                                                                            @ADDRESSINFOSOURCECOMMENTS          NVARCHAR(256),
                                                                            @ADDRESSCOUNTYCODEID                UNIQUEIDENTIFIER,
                                                                            @ADDRESSREGIONCODEID                UNIQUEIDENTIFIER,
                                                                            @ADDRESSCONGRESSIONALDISTRICTCODEID UNIQUEIDENTIFIER,
                                                                            @ADDRESSSTATEHOUSEDISTRICTCODEID    UNIQUEIDENTIFIER,
                                                                            @ADDRESSSTATESENATEDISTRICTCODEID   UNIQUEIDENTIFIER,
                                                                            @ADDRESSLOCALPRECINCTCODEID         UNIQUEIDENTIFIER,
                                                                            @ADDRESSCERTIFICATIONDATA           INT,
                                                                            @ADDRESSLASTVALIDATIONATTEMPTDATE   DATE,
                                                                            @ADDRESSOMITFROMVALIDATION          BIT,
                                                                            @ADDRESSVALIDATIONMESSAGE           NVARCHAR(200),
                                                                            @PHONEDONOTCALL                     BIT,
                                                                            @PHONESTARTTIME                     DBO.UDT_HOURMINUTE,
                                                                            @PHONEENDTIME                       DBO.UDT_HOURMINUTE,
                                                                            @PHONEINFOSOURCECODEID              UNIQUEIDENTIFIER,
                                                                            @PHONECOUNTRYID                     UNIQUEIDENTIFIER,
                                                                            @PHONESTARTDATE                     DATE,
                                                                            @PHONEENDDATE                       DATE,
                                                                            @PHONESEASONALSTARTDATE             DBO.UDT_MONTHDAY,
                                                                            @PHONESEASONALENDDATE               DBO.UDT_MONTHDAY,
                                                                            @EMAILADDRESSDONOTEMAIL             BIT,
                                                                            @EMAILADDRESSINFOSOURCECODEID       UNIQUEIDENTIFIER,
                                                                            @EMAILADDRESSSTARTDATE              DATE,
                                                                            @EMAILADDRESSENDDATE                DATE,
                                                                            @CONSTITUENCIES                     XML)
AS
    SET NOCOUNT ON;

    IF @CHANGEAGENTID IS NULL
      EXEC DBO.USP_CHANGEAGENT_GETORCREATECHANGEAGENT
        @CHANGEAGENTID OUTPUT

    DECLARE @CURRENTDATE DATETIME

    SET @CURRENTDATE = GETDATE()

    IF @CONSTITUENTACTION IS NULL
      SET @CONSTITUENTACTION = 0;

    IF @ADDRESSACTION IS NULL
      SET @ADDRESSACTION = 0;

    IF @EMAILACTION IS NULL
      SET @EMAILACTION = 0;

    IF @PHONEACTION IS NULL
      SET @PHONEACTION = 0;

    IF @FIRSTNAME IS NULL
      SET @FIRSTNAME = '';

    IF @MIDDLENAME IS NULL
      SET @MIDDLENAME = '';

    BEGIN TRY
        ------------GET CONSTITUENT UPDATE RULES --------------
        DECLARE @NEWADDRESSENDDATECODE TINYINT
        DECLARE @CREATEHISTORICALNAMECODE TINYINT
        DECLARE @NEWPHONEENDDATECODE TINYINT
        DECLARE @NEWEMAILENDDATECODE TINYINT

        SELECT @NEWADDRESSENDDATECODE = NEWADDRESSENDDATECODE,
               @CREATEHISTORICALNAMECODE = CREATEHISTORICALNAMECODE,
               @NEWPHONEENDDATECODE = NEWPHONEENDDATECODE,
               @NEWEMAILENDDATECODE = NEWEMAILENDDATECODE
        FROM   DBO.CONSTITUENTBUSINESSRULESSETTINGS

        DECLARE @NEWID UNIQUEIDENTIFIER;

        ------------CONSTITUENT HANDLING------------------------
        IF @CONSTITUENTACTION = 1 --Add constituent as alias (same SP can be used for both individuals and organizations)
          BEGIN
              DECLARE @IGNOREDUPLICATE BIT = 1; --if we are here we want to ignore the duplicate error message and continue on.
              EXEC DBO.USP_ADD_INDIVIDUAL_ALIAS
                @CHANGEAGENTID = @CHANGEAGENTID,
                @CONSTITUENTID = @ID,
                @KEYNAME = @LASTNAME,
                @FIRSTNAME = @FIRSTNAME,
                @MIDDLENAME = @MIDDLENAME,
                @TITLECODEID = @TITLECODEID,
                @SUFFIXCODEID = @SUFFIXCODEID,
                @IGNOREDUPLICATE = @IGNOREDUPLICATE
          END;
        ELSE IF @CONSTITUENTACTION = 2 --Constiutent fields update
          BEGIN
              DECLARE @PICTURE          VARBINARY(MAX),
                      @PICTURETHUMBNAIL VARBINARY(MAX),
                      @PICTURECHANGED   BIT,
                      @TITLE2CODEID     UNIQUEIDENTIFIER,
                      @SUFFIX2CODEID    UNIQUEIDENTIFIER,
                      @ORGISPRIMARY     BIT,
                      @PARENTCORPID     UNIQUEIDENTIFIER;

              -- Save old name as a historical name if the rule calls for it.
              IF @CREATEHISTORICALNAMECODE = 1
                EXEC DBO.USP_CREATE_HISTORICALNAME
                  @ID,
                  @LASTNAME,
                  @FIRSTNAME,
                  @MIDDLENAME,
                  @TITLECODEID,
                  @SUFFIXCODEID,
                  @CHANGEAGENTID;

              IF @ISORGANIZATION = 1 -- Update organization
                BEGIN
                    -- load organization to updated
                    EXEC DBO.USP_ORGANIZATION_EDITLOAD
                      @ID,
                      @PARENTCORPID = @PARENTCORPID OUTPUT,
                      @PICTURE = @PICTURE OUTPUT,
                      @PICTURETHUMBNAIL = @PICTURETHUMBNAIL OUTPUT,
                      @PICTURECHANGED = @PICTURECHANGED OUTPUT,
                      @ISPRIMARY = @ORGISPRIMARY OUTPUT;

                    -- save organization fields
                    EXEC DBO.USP_ORGANIZATION_EDITSAVE
                      @ID,
                      @CHANGEAGENTID,
                      @LASTNAME,
                      @INDUSTRYCODEID,
                      @NUMEMPLOYEES,
                      @NUMSUBSIDIARIES,
                      @PARENTCORPID,
                      @PICTURE,
                      @PICTURETHUMBNAIL,
                      @PICTURECHANGED,
                      @WEBADDRESS,
                      @ORGISPRIMARY;
                END;
              ELSE -- Update individual
                BEGIN
                    -- load individual to update
                    EXEC DBO.USP_INDIVIDUAL_EDITLOAD
                      @ID,
                      @PICTURE = @PICTURE OUTPUT,
                      @PICTURETHUMBNAIL = @PICTURETHUMBNAIL OUTPUT,
                      @PICTURECHANGED = @PICTURECHANGED OUTPUT,
                      @TITLE2CODEID = @TITLE2CODEID OUTPUT,
                      @SUFFIX2CODEID = @SUFFIX2CODEID OUTPUT;

                    -- save individual fields
                    EXEC DBO.USP_INDIVIDUAL_EDITSAVE_2
                      @ID,
                      @CHANGEAGENTID,
                      @LASTNAME,
                      @FIRSTNAME,
                      @MIDDLENAME,
                      @MAIDENNAME,
                      @NICKNAME,
                      @TITLECODEID,
                      @SUFFIXCODEID,
                      @GENDERCODE,
                      @BIRTHDATE,
                      @GIVESANONYMOUSLY,
                      @PICTURE,
                      @PICTURETHUMBNAIL,
                      @PICTURECHANGED,
                      @WEBADDRESS,
                      @MARITALSTATUSCODEID,
                      @TITLE2CODEID,
                      @SUFFIX2CODEID,
                      @DECEASED,
                      @DECEASEDDATE;
                END;
          END;

        --------------ADDRESSES----------------------------------
        IF @ADDRESSACTION = 1 -- Add secondary address
          BEGIN
              DECLARE @ADDRESS_ISPRIMARY BIT

              SELECT @ADDRESSTYPECODEID = T.C.value('(ADDRESSTYPECODEID)[1]', 'uniqueidentifier'),
                     @ADDRESS_COUNTRYID = T.C.value('(COUNTRYID)[1]', 'uniqueidentifier'),
                     @ADDRESS_STATEID = T.C.value('(STATEID)[1]', 'uniqueidentifier'),
                     @ADDRESS_ADDRESSBLOCK = T.C.value('(ADDRESSBLOCK)[1]', 'nvarchar(150)'),
                     @ADDRESS_CITY = T.C.value('(CITY)[1]', 'nvarchar(50)'),
                     @ADDRESS_POSTCODE = T.C.value('(POSTCODE)[1]', 'nvarchar(12)'),
                     @ADDRESS_ISPRIMARY = T.C.value('(ISPRIMARY)[1]', 'bit')
              FROM   @ADDRESSES.nodes('/ADDRESSES/ITEM') T(C)
              WHERE  T.C.value('(ADDRESSID)[1]', 'uniqueidentifier') IS NULL;

              EXEC DBO.USP_ADDRESS_ADD
                @ID = @NEWID OUTPUT,
                @CHANGEAGENTID = @CHANGEAGENTID,
                @CONSTITUENTID = @ID,
                @ADDRESSTYPECODEID = @ADDRESSTYPECODEID,
                @COUNTRYID = @ADDRESS_COUNTRYID,
                @STATEID = @ADDRESS_STATEID,
                @ADDRESSBLOCK = @ADDRESS_ADDRESSBLOCK,
                @CITY = @ADDRESS_CITY,
                @POSTCODE = @ADDRESS_POSTCODE,
                @PRIMARY = @ADDRESS_ISPRIMARY;

              -- end date any existing addresses if the rule says to and the addresstype matches some other address type
              IF @NEWADDRESSENDDATECODE = 0 --then end date any existing addresses with same type code
                BEGIN
                    UPDATE DBO.ADDRESS
                    SET    DONOTMAIL = 1,
                           HISTORICALENDDATE = ISNULL(HISTORICALENDDATE, @CURRENTDATE)
                    WHERE  CONSTITUENTID = @ID
                           AND ( HISTORICALENDDATE IS NULL
                                  OR DONOTMAIL = 0 )
                           AND ADDRESSTYPECODEID = @ADDRESSTYPECODEID
                           AND ID <> @NEWID
                           AND ISPRIMARY = 0
                END
          END
        ELSE IF @ADDRESSACTION = 2 -- Update current acction
          BEGIN
              -- invoke address load
              DECLARE @PRIMARY                               BIT,
                      @UPDATECONTACTS                        BIT,
                      @UPDATEMATCHINGHOUSEHOLDADDRESSES      BIT,
                      @ISCONFIDENTIAL                        BIT,
                      @CONSTITUENTDATAREVIEWROLLBACKREASONID UNIQUEIDENTIFIER;

              EXEC DBO.USP_ADDRESS_EDITLOAD
                @ADDRESSID,
                @PRIMARY = @PRIMARY OUTPUT,
                @UPDATECONTACTS = @UPDATECONTACTS OUTPUT,
                @UPDATEMATCHINGHOUSEHOLDADDRESSES = @UPDATEMATCHINGHOUSEHOLDADDRESSES OUTPUT,
                @ISCONFIDENTIAL = @ISCONFIDENTIAL OUTPUT,
                @CONSTITUENTDATAREVIEWROLLBACKREASONID = @CONSTITUENTDATAREVIEWROLLBACKREASONID OUTPUT;

              -- update current address
              EXEC DBO.USP_ADDRESS_EDITSAVE
                @ADDRESSID,
                @CHANGEAGENTID,
                @ADDRESSTYPECODEID,
                @PRIMARY,
                @ADDRESSDONOTMAIL,
                @ADDRESSSTARTDATE,
                @ADDRESSENDDATE,
                @ADDRESS_COUNTRYID,
                @ADDRESS_STATEID,
                @ADDRESS_ADDRESSBLOCK,
                @ADDRESS_CITY,
                @ADDRESS_POSTCODE,
                @ADDRESSCART,
                @ADDRESSDPC,
                @ADDRESSLOT,
                @ADDRESSOMITFROMVALIDATION,
                @ADDRESSCOUNTYCODEID,
                @ADDRESSCONGRESSIONALDISTRICTCODEID,
                @ADDRESSSTATEHOUSEDISTRICTCODEID,
                @ADDRESSSTATESENATEDISTRICTCODEID,
                @ADDRESSLOCALPRECINCTCODEID,
                @ADDRESSINFOSOURCECODEID,
                @ADDRESSREGIONCODEID,
                @ADDRESSLASTVALIDATIONATTEMPTDATE,
                @ADDRESSVALIDATIONMESSAGE,
                @ADDRESSCERTIFICATIONDATA,
                @UPDATECONTACTS,
                @ADDRESSDONOTMAILREASONCODEID,
                @UPDATEMATCHINGHOUSEHOLDADDRESSES,
                @ADDRESSHISTORICALSTARTDATE,
                @ADDRESSHISTORICALENDDATE,
                @ADDRESSINFOSOURCECOMMENTS,
                @ISCONFIDENTIAL,
                @CONSTITUENTDATAREVIEWROLLBACKREASONID;
          END;

        ----------------EMAILS----------------------------
        IF @EMAILACTION = 1 -- add as secondary email
          BEGIN
              DECLARE @EMAILPRIMARY                        BIT,
                      @UPDATEMATCHINGHOUSEHOLDEMAILADDRESS BIT,
                      @EMAILINFOSOURCECOMMENTS             NVARCHAR(256);

              SELECT @EMAILADDRESSTYPECODEID = T.C.value('(EMAILADDRESSTYPECODEID)[1]', 'uniqueidentifier'),
                     @EMAILADDRESS = T.C.value('(EMAILADDRESS)[1]', 'dbo.UDT_EMAILADDRESS'),
                     @EMAILADDRESSSTARTDATE = T.C.value('(STARTDATE)[1]', 'datetime'),
                     @EMAILPRIMARY = T.C.value('(ISPRIMARY)[1]', 'bit')
              FROM   @EMAILS.nodes('/EMAILS/ITEM') T(C)
              WHERE  T.C.value('(EMAILADDRESSID)[1]', 'uniqueidentifier') IS NULL;

              -- add email address
              EXEC DBO.USP_EMAILADDRESS_CREATE
                @ID = @NEWID OUTPUT,
                @CHANGEAGENTID = @CHANGEAGENTID,
                @CURRENTDATE = @CURRENTDATE,
                @CONSTITUENTID = @ID,
                @EMAILADDRESSTYPECODEID = @EMAILADDRESSTYPECODEID,
                @EMAILADDRESS = @EMAILADDRESS,
                @PRIMARY = @EMAILPRIMARY,
                @STARTDATE = @EMAILADDRESSSTARTDATE;

              IF @NEWEMAILENDDATECODE = 0 --then end date any existing email with same type code
                BEGIN
                    UPDATE DBO.EMAILADDRESS
                    SET    DONOTEMAIL = 1,
                           ENDDATE = ISNULL(ENDDATE, @CURRENTDATE)
                    WHERE  CONSTITUENTID = @ID
                           AND ( ENDDATE IS NULL
                                  OR DONOTEMAIL = 0 )
                           AND EMAILADDRESSTYPECODEID = @EMAILADDRESSTYPECODEID
                           AND ID <> @NEWID
                           AND ISPRIMARY = 0
                END
          END
        ELSE IF @EMAILACTION = 2 -- update current email
          BEGIN
              -- invoke email load
              EXEC DBO.USP_EMAILADDRESS_EDITLOAD
                @EMAILID,
                @PRIMARY = @EMAILPRIMARY OUTPUT,
                @UPDATEMATCHINGHOUSEHOLDEMAILADDRESS = @UPDATEMATCHINGHOUSEHOLDEMAILADDRESS OUTPUT,
                @INFOSOURCECOMMENTS = @EMAILINFOSOURCECOMMENTS OUTPUT;

              -- update email address
              EXEC DBO.USP_EMAILADDRESS_UPDATE
                @EMAILID,
                @CHANGEAGENTID,
                @CURRENTDATE,
                @EMAILADDRESSTYPECODEID,
                @EMAILADDRESS,
                @EMAILPRIMARY,
                @EMAILADDRESSDONOTEMAIL,
                @UPDATEMATCHINGHOUSEHOLDEMAILADDRESS,
                @EMAILADDRESSINFOSOURCECODEID,
                @EMAILINFOSOURCECOMMENTS,
                @EMAILADDRESSSTARTDATE,
                @EMAILADDRESSENDDATE;
          END;

        ----------------PHONES----------------------------
        IF @PHONEACTION = 1 -- add as secondary phone
          BEGIN
              DECLARE @PHONEISPRIMARY               BIT,
                      @UPDATEMATCHINGHOUSEHOLDPHONE BIT,
                      @PHONEDONOTCALLREASONCODEID   UNIQUEIDENTIFIER,
                      @PHONEINFOSOURCECOMMENTS      NVARCHAR(256),
                      @PHONEISCONFIDENTIAL          BIT;

              SELECT @PHONETYPECODEID = T.C.value('(PHONETYPECODEID)[1]', 'uniqueidentifier'),
                     @PHONENUMBER = T.C.value('(PHONENUMBER)[1]', 'nvarchar(100)'),
                     @PHONEISPRIMARY = T.C.value('(ISPRIMARY)[1]', 'bit')
              FROM   @PHONES.nodes('/PHONES/ITEM') T(C)
              WHERE  T.C.value('(PHONEID)[1]', 'uniqueidentifier') IS NULL;

              EXEC DBO.USP_PHONE_CREATE
                @ID = @NEWID OUTPUT,
                @CHANGEAGENTID = @CHANGEAGENTID,
                @CURRENTDATE = @CURRENTDATE,
                @CONSTITUENTID = @ID,
                @PHONETYPECODEID = @PHONETYPECODEID,
                @NUMBER = @PHONENUMBER,
                @PRIMARY = @PHONEISPRIMARY,
                @COUNTRYID = @ADDRESS_COUNTRYID;

              IF @NEWPHONEENDDATECODE = 0 --then end date any existing PHONE with same type code
                BEGIN
                    UPDATE DBO.PHONE
                    SET    DONOTCALL = 1,
                           ENDDATE = ISNULL(ENDDATE, @CURRENTDATE)
                    WHERE  CONSTITUENTID = @ID
                           AND ( ENDDATE IS NULL
                                  OR DONOTCALL = 0 )
                           AND PHONETYPECODEID = @PHONETYPECODEID
                           AND ID <> @NEWID
                           AND ISPRIMARY = 0
                END
          END
        ELSE IF @PHONEACTION = 2 -- update current phone
          BEGIN
              -- phone data load
              EXEC DBO.USP_PHONE_EDITLOAD
                @PHONEID,
                @PRIMARY = @PHONEISPRIMARY OUTPUT,
                @UPDATEMATCHINGHOUSEHOLDPHONE = @UPDATEMATCHINGHOUSEHOLDPHONE OUTPUT,
                @INFOSOURCECOMMENTS = @PHONEINFOSOURCECOMMENTS OUTPUT,
                @DONOTCALLREASONCODEID = @PHONEDONOTCALLREASONCODEID OUTPUT,
                @ISCONFIDENTIAL = @PHONEISCONFIDENTIAL OUTPUT;

              -- update phone
              EXEC DBO.USP_PHONE_UPDATE
                @PHONEID,
                @CHANGEAGENTID,
                @CURRENTDATE,
                @PHONETYPECODEID,
                @PHONENUMBER,
                @PHONEISPRIMARY,
                @PHONEDONOTCALL,
                @UPDATEMATCHINGHOUSEHOLDPHONE,
                @PHONESTARTTIME,
                @PHONEENDTIME,
                @PHONEINFOSOURCECODEID,
                @PHONEINFOSOURCECOMMENTS,
                @PHONECOUNTRYID,
                @PHONESTARTDATE,
                @PHONEENDDATE,
                @PHONEDONOTCALLREASONCODEID,
                @PHONEISCONFIDENTIAL,
                @PHONESEASONALSTARTDATE,
                @PHONESEASONALENDDATE;
          END;
    ----------------CONSTITUENCIES----------------------------
    -- Constituencies duplicate resolution support is only being added to CUB for now
    -- CUB uses ConstituentUpdateBatchDuplicateMatch.Edit to save the constituencies data
    -- so we don't need to add it here
    END TRY
    BEGIN CATCH
        EXEC DBO.USP_RAISE_ERROR
        RETURN 1
    END CATCH

    RETURN 0; 


]]>


      </d1p1:CreateProcedureSQL>
    </SaveImplementation>
  </SPDataForm>
  <d1p1:FormMetaData FixedDialog="true">
    <d1p1:FormFields>
      <d1p1:FormField FieldID="LOOKUPID" MaxLength="50" Caption="Lookupid" CaptionResourceKey="$$lookupid" />
      <d1p1:FormField FieldID="FIRSTNAME" MaxLength="50" Caption="First name" CaptionResourceKey="$$first_name" />
      <d1p1:FormField FieldID="MIDDLENAME" MaxLength="50" Caption="Middle name" CaptionResourceKey="$$middle_name" />
      <d1p1:FormField FieldID="LASTNAME" MaxLength="100" Caption="Last\org\group\household" CaptionResourceKey="$$last\org\group\household" />
      <d1p1:FormField FieldID="SUFFIXCODEID" DataType="Guid" Caption="Suffix" CaptionResourceKey="$$suffix" />
      <d1p1:FormField FieldID="TITLECODEID" DataType="Guid" Caption="Title" CaptionResourceKey="$$title" />
      <d1p1:FormField FieldID="MAIDENNAME" MaxLength="100" Caption="Maiden name" CaptionResourceKey="$$maiden_name" />
      <d1p1:FormField FieldID="NICKNAME" MaxLength="50" Caption="Nickname" CaptionResourceKey="$$nickname" />
      <d1p1:FormField FieldID="GENDERCODE" DataType="TinyInt" Caption="Gender" CaptionResourceKey="$$gender">
        <d1p1:ValueList>
          <d1p1:Items>
            <d1p1:Item LabelResourceKey="$$unknown">
              <d1p1:Value>0</d1p1:Value>
              <d1p1:Label>Unknown</d1p1:Label>
            </d1p1:Item>
            <d1p1:Item LabelResourceKey="$$male">
              <d1p1:Value>1</d1p1:Value>
              <d1p1:Label>Male</d1p1:Label>
            </d1p1:Item>
            <d1p1:Item LabelResourceKey="$$female">
              <d1p1:Value>2</d1p1:Value>
              <d1p1:Label>Female</d1p1:Label>
            </d1p1:Item>
          </d1p1:Items>
        </d1p1:ValueList>
      </d1p1:FormField>
      <d1p1:FormField FieldID="BIRTHDATE" DataType="FuzzyDate" Caption="Date of birth" AllowMonthDayOnFuzzyDate="true" CaptionResourceKey="$$date_of_birth" />
      <d1p1:FormField FieldID="ADDRESSID" DataType="Guid" Caption="Address ID" CaptionResourceKey="$$address_id" />
      <d1p1:FormField FieldID="ADDRESSTYPECODEID" DataType="Guid" Hidden="true" />
      <d1p1:FormField FieldID="ADDRESS_ADDRESSBLOCK" MaxLength="150" Caption="Address" CaptionResourceKey="$$address" />
      <d1p1:FormField FieldID="ADDRESS_CITY" MaxLength="50" Caption="City" CaptionResourceKey="$$city" />
      <d1p1:FormField FieldID="ADDRESS_STATEID" DataType="Guid" Caption="State" CaptionResourceKey="$$state">
        <d1p1:SimpleDataList SimpleDataListID="7fa91401-596c-4f7c-936d-6e41683121d7">
          <d1p1:Params>
            <d1p1:Param ID="COUNTRYID">
              <d1p1:Value>Fields!ADDRESS_COUNTRYID</d1p1:Value>
            </d1p1:Param>
          </d1p1:Params>
        </d1p1:SimpleDataList>
      </d1p1:FormField>
      <d1p1:FormField FieldID="ADDRESS_POSTCODE" MaxLength="12" Caption="ZIP" CaptionResourceKey="$$zip" />
      <d1p1:FormField FieldID="ADDRESS_COUNTRYID" DataType="Guid" Caption="Countryid" CaptionResourceKey="$$countryid" />
      <d1p1:FormField FieldID="PHONEID" DataType="Guid" Caption="Phone ID" CaptionResourceKey="$$phone_id" />
      <d1p1:FormField FieldID="PHONETYPECODEID" DataType="Guid" Hidden="true" />
      <d1p1:FormField FieldID="PHONENUMBER" MaxLength="100" Caption="Phone" CaptionResourceKey="$$phone" />
      <d1p1:FormField FieldID="EMAILID" DataType="Guid" Caption="Email ID" CaptionResourceKey="$$email_id" />
      <d1p1:FormField FieldID="EMAILADDRESSTYPECODEID" DataType="Guid" Hidden="true" />
      <d1p1:FormField FieldID="EMAILADDRESS" DataType="EmailAddress" MaxLength="100" Caption="Email" CaptionResourceKey="$$email" />
      <d1p1:FormField FieldID="CREATEDON" DataType="Date" Caption="Created on" CaptionResourceKey="$$created_on" />
      <d1p1:FormField FieldID="DATECHANGED" DataType="Date" Caption="Date changed" CaptionResourceKey="$$date_changed" />
      <d1p1:FormField FieldID="ADDRESSES" DataType="XML" Hidden="true">
        <d1p1:Collection>
          <d1p1:Fields>
            <d1p1:FormField FieldID="ADDRESSID" DataType="Guid" Caption="Address ID" CaptionResourceKey="$$address_id" />
            <d1p1:FormField FieldID="ADDRESSTYPECODEID" DataType="Guid" Caption="Address type code ID" CaptionResourceKey="$$address_type_code_id">
              <d1p1:CodeTable CodeTableName="ADDRESSTYPECODE" />
            </d1p1:FormField>
            <d1p1:FormField FieldID="ADDRESSBLOCK" Caption="Address block" CaptionResourceKey="$$address_block" />
            <d1p1:FormField FieldID="CITY" Caption="City" CaptionResourceKey="$$city" />
            <d1p1:FormField FieldID="STATEID" DataType="Guid" Caption="State" CaptionResourceKey="$$state">
              <d1p1:SimpleDataList SimpleDataListID="7fa91401-596c-4f7c-936d-6e41683121d7">
                <d1p1:Params>
                  <d1p1:Param ID="COUNTRYID">
                    <d1p1:Value>Fields!ADDRESS_COUNTRYID</d1p1:Value>
                  </d1p1:Param>
                </d1p1:Params>
              </d1p1:SimpleDataList>
            </d1p1:FormField>
            <d1p1:FormField FieldID="POSTCODE" Caption="ZIP/Postal Code" CaptionResourceKey="$$zip/postal_code" />
            <d1p1:FormField FieldID="STARTDATE" DataType="MonthDay" Caption="Start date" CaptionResourceKey="$$start_date" />
            <d1p1:FormField FieldID="ENDDATE" DataType="MonthDay" Caption="End date" CaptionResourceKey="$$end_date" />
            <d1p1:FormField FieldID="ISPRIMARY" DataType="Boolean" Caption="Is primary" CaptionResourceKey="$$is_primary" />
            <d1p1:FormField FieldID="COUNTRYID" DataType="Guid" Caption="Countryid" CaptionResourceKey="$$countryid" />
            <d1p1:FormField FieldID="FULLADDRESS" Caption="Full address" CaptionResourceKey="$$full_address" />
            <d1p1:FormField FieldID="LASTUPDATED" DataType="Date" Caption="Last updated" CaptionResourceKey="$$last_updated" />
            <d1p1:FormField FieldID="HISTORICALSTARTDATE" DataType="Date" Caption="Start" CaptionResourceKey="$$start" />
            <d1p1:FormField FieldID="HISTORICALENDDATE" DataType="Date" Caption="End" CaptionResourceKey="$$end" />
          </d1p1:Fields>
        </d1p1:Collection>
      </d1p1:FormField>
      <d1p1:FormField FieldID="PHONES" DataType="XML" Hidden="true">
        <d1p1:Collection>
          <d1p1:Fields>
            <d1p1:FormField FieldID="PHONEID" DataType="Guid" Caption="Phone ID" CaptionResourceKey="$$phone_id" />
            <d1p1:FormField FieldID="PHONETYPECODEID" DataType="Guid" Caption="Phone type code ID" CaptionResourceKey="$$phone_type_code_id">
              <d1p1:CodeTable CodeTableName="PHONETYPECODE" />
            </d1p1:FormField>
            <d1p1:FormField FieldID="PHONENUMBER" Caption="Phone number" CaptionResourceKey="$$phone_number" ApplyPhoneFormatting="true" />
            <d1p1:FormField FieldID="STARTDATE" DataType="Date" Caption="Start date" CaptionResourceKey="$$start_date" />
            <d1p1:FormField FieldID="ENDDATE" DataType="Date" Caption="End date" CaptionResourceKey="$$end_date" />
            <d1p1:FormField FieldID="ISPRIMARY" DataType="Boolean" Caption="Is primary" CaptionResourceKey="$$is_primary" />
            <d1p1:FormField FieldID="LASTUPDATED" DataType="Date" Caption="Last updated" CaptionResourceKey="$$last_updated" />
          </d1p1:Fields>
        </d1p1:Collection>
      </d1p1:FormField>
      <d1p1:FormField FieldID="EMAILS" DataType="XML" Hidden="true">
        <d1p1:Collection>
          <d1p1:Fields>
            <d1p1:FormField FieldID="EMAILADDRESSID" DataType="Guid" Caption="Email address ID" CaptionResourceKey="$$email_address_id" />
            <d1p1:FormField FieldID="EMAILADDRESSTYPECODEID" DataType="Guid" Caption="Email address type code id" CaptionResourceKey="$$email_address_type_code_id">
              <d1p1:CodeTable CodeTableName="EMAILADDRESSTYPECODE" />
            </d1p1:FormField>
            <d1p1:FormField FieldID="EMAILADDRESS" DataType="EmailAddress" Caption="Email address" CaptionResourceKey="$$email_address" />
            <d1p1:FormField FieldID="STARTDATE" DataType="Date" Caption="Start date" CaptionResourceKey="$$start_date" />
            <d1p1:FormField FieldID="ENDDATE" DataType="Date" Caption="End date" CaptionResourceKey="$$end_date" />
            <d1p1:FormField FieldID="ISPRIMARY" DataType="Boolean" Caption="Is primary" CaptionResourceKey="$$is_primary" />
            <d1p1:FormField FieldID="LASTUPDATED" DataType="Date" Caption="Last updated" CaptionResourceKey="$$last_updated" />
          </d1p1:Fields>
        </d1p1:Collection>
      </d1p1:FormField>
      <d1p1:FormField FieldID="SPOUSENAME" MaxLength="154" Caption="Spouse name" CaptionResourceKey="$$spouse_name" />
      <d1p1:FormField FieldID="SPOUSELOOKUPID" MaxLength="50" Caption="Spouse lookup ID" CaptionResourceKey="$$spouse_lookup_id" />
      <d1p1:FormField FieldID="SPOUSESTARTDATE" DataType="Date" Caption="Spouse start date" CaptionResourceKey="$$spouse_start_date" />
      <d1p1:FormField FieldID="SPOUSEENDDATE" DataType="Date" Caption="Spouse end date" CaptionResourceKey="$$spouse_end_date" />
      <d1p1:FormField FieldID="HOUSEHOLDNAME" MaxLength="154" Caption="Household name" CaptionResourceKey="$$household_name" />
      <d1p1:FormField FieldID="HOUSEHOLDLOOKUPID" MaxLength="50" Caption="Household lookup ID" CaptionResourceKey="$$household_lookup_id" />
      <d1p1:FormField FieldID="BUSINESSNAME" MaxLength="154" Caption="Business name" CaptionResourceKey="$$business_name" />
      <d1p1:FormField FieldID="BUSINESSLOOKUPID" MaxLength="50" Caption="Business lookup ID" CaptionResourceKey="$$business_lookup_id" />
      <d1p1:FormField FieldID="CONSTITUENTACTION" DataType="TinyInt" Hidden="true" Caption="CONSTITUENTACTION" />
      <d1p1:FormField FieldID="ADDRESSACTION" DataType="TinyInt" Hidden="true" Caption="ADDRESSACTION" />
      <d1p1:FormField FieldID="EMAILACTION" DataType="TinyInt" Hidden="true" Caption="EMAILACTION" />
      <d1p1:FormField FieldID="PHONEACTION" DataType="TinyInt" Hidden="true" Caption="PHONEACTION" />
      <d1p1:FormField FieldID="ISORGANIZATION" DataType="Boolean" Hidden="true" Caption="ISORGANIZATION" />
      <d1p1:FormField FieldID="INDUSTRYCODEID" DataType="Guid" Caption="Industry" CaptionResourceKey="$$industry">
        <d1p1:CodeTable CodeTableName="INDUSTRYCODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="NUMEMPLOYEES" DataType="Integer" Caption="No. of employees" CaptionResourceKey="$$no_of_employees" />
      <d1p1:FormField FieldID="NUMSUBSIDIARIES" DataType="Integer" Caption="No. of subsidiary orgs" CaptionResourceKey="$$no_of_subsidiary_orgs" />
      <d1p1:FormField FieldID="MARITALSTATUSCODEID" DataType="Guid" Caption="Marital status" CaptionResourceKey="$$marital_status">
        <d1p1:CodeTable CodeTableName="MARITALSTATUSCODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="DECEASED" DataType="Boolean" Caption="Is deceased" CaptionResourceKey="$$is_deceased" />
      <d1p1:FormField FieldID="DECEASEDDATE" DataType="FuzzyDate" Caption="Deceased date" CaptionResourceKey="$$deceased_date" />
      <d1p1:FormField FieldID="GIVESANONYMOUSLY" DataType="Boolean" Caption="Gives anonymously" CaptionResourceKey="$$gives_anonymously" />
      <d1p1:FormField FieldID="WEBADDRESS" DataType="WebAddress" Caption="Website" CaptionResourceKey="$$website" />
      <d1p1:FormField FieldID="ADDRESSHISTORICALSTARTDATE" DataType="Date" Caption="Address start date" CaptionResourceKey="$$address_start_date" />
      <d1p1:FormField FieldID="ADDRESSHISTORICALENDDATE" DataType="Date" Caption="Address end date" CaptionResourceKey="$$address_end_date" />
      <d1p1:FormField FieldID="ADDRESSDONOTMAIL" DataType="Boolean" Caption="Do not send mail to this address" CaptionResourceKey="$$do_not_send_mail_to_this_address" />
      <d1p1:FormField FieldID="ADDRESSDONOTMAILREASONCODEID" DataType="Guid" Caption="Do not mail reason" CaptionResourceKey="$$do_not_mail_reason">
        <d1p1:CodeTable CodeTableName="DONOTMAILREASONCODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="ADDRESSSTARTDATE" DataType="MonthDay" Caption="Seasonal start date" CaptionResourceKey="$$seasonal_start_date" />
      <d1p1:FormField FieldID="ADDRESSENDDATE" DataType="MonthDay" Caption="Seasonal end date" CaptionResourceKey="$$seasonal_end_date" />
      <d1p1:FormField FieldID="ADDRESSINFOSOURCECODEID" DataType="Guid" Caption="Info source" CaptionResourceKey="$$info_source">
        <d1p1:CodeTable CodeTableName="INFOSOURCECODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="ADDRESSCOUNTYCODEID" DataType="Guid" Caption="County" CaptionResourceKey="$$county">
        <d1p1:CodeTable CodeTableName="COUNTYCODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="ADDRESSDPC" Caption="DPC" CaptionResourceKey="$$dpc" />
      <d1p1:FormField FieldID="ADDRESSCART" Caption="CART" CaptionResourceKey="$$cart" />
      <d1p1:FormField FieldID="ADDRESSLOT" MaxLength="5" Caption="LOT" CaptionResourceKey="$$lot" />
      <d1p1:FormField FieldID="ADDRESSREGIONCODEID" DataType="Guid" Caption="Region" CaptionResourceKey="$$region">
        <d1p1:CodeTable CodeTableName="REGIONCODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="ADDRESSCONGRESSIONALDISTRICTCODEID" DataType="Guid" Caption="Congressional district" CaptionResourceKey="$$congressional_district">
        <d1p1:CodeTable CodeTableName="CONGRESSIONALDISTRICTCODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="ADDRESSSTATEHOUSEDISTRICTCODEID" DataType="Guid" Caption="State house district" CaptionResourceKey="$$state_house_district">
        <d1p1:CodeTable CodeTableName="STATEHOUSEDISTRICTCODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="ADDRESSSTATESENATEDISTRICTCODEID" DataType="Guid" Caption="State senate district" CaptionResourceKey="$$state_senate_district">
        <d1p1:CodeTable CodeTableName="STATESENATEDISTRICTCODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="ADDRESSLOCALPRECINCTCODEID" DataType="Guid" Caption="Local precinct" CaptionResourceKey="$$local_precinct">
        <d1p1:CodeTable CodeTableName="LOCALPRECINCTCODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="ADDRESSCERTIFICATIONDATA" DataType="Integer" Caption="Certification data" CaptionResourceKey="$$certification_data" />
      <d1p1:FormField FieldID="ADDRESSLASTVALIDATIONATTEMPTDATE" DataType="Date" Caption="Last validation attempt date" CaptionResourceKey="$$last_validation_attempt_date" />
      <d1p1:FormField FieldID="ADDRESSOMITFROMVALIDATION" DataType="Boolean" Caption="Omit from validation" CaptionResourceKey="$$omit_from_validation" />
      <d1p1:FormField FieldID="ADDRESSVALIDATIONMESSAGE" MaxLength="200" Caption="Validation message" CaptionResourceKey="$$validation_message" />
      <d1p1:FormField FieldID="ADDRESSINFOSOURCECOMMENTS" MaxLength="256" Caption="Info source comments" CaptionResourceKey="$$info_source_comments" />
      <d1p1:FormField FieldID="PHONECOUNTRYID" DataType="Guid" Caption="Phone country" CaptionResourceKey="$$phone_country">
        <d1p1:SimpleDataList SimpleDataListID="c9649672-353d-42e8-8c25-4d34bbabfbba" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="PHONESEASONALSTARTDATE" DataType="MonthDay" Caption="Seasonal start" CaptionResourceKey="$$seasonal_start" />
      <d1p1:FormField FieldID="PHONESEASONALENDDATE" DataType="MonthDay" Caption="Seasonal end" CaptionResourceKey="$$seasonal_end" />
      <d1p1:FormField FieldID="PHONEDONOTCALL" DataType="Boolean" Caption="Do not call this number" CaptionResourceKey="$$do_not_call_this_number" />
      <d1p1:FormField FieldID="PHONESTARTTIME" DataType="HourMinute" Caption="Call after" CaptionResourceKey="$$call_after" />
      <d1p1:FormField FieldID="PHONEENDTIME" DataType="HourMinute" Caption="Call before" CaptionResourceKey="$$call_before" />
      <d1p1:FormField FieldID="PHONESTARTDATE" DataType="Date" Caption="Phone start date" CaptionResourceKey="$$phone_start_date" />
      <d1p1:FormField FieldID="PHONEENDDATE" DataType="Date" Caption="Phone end date" CaptionResourceKey="$$phone_end_date" />
      <d1p1:FormField FieldID="PHONEINFOSOURCECODEID" DataType="Guid" Caption="Info source" CaptionResourceKey="$$info_source">
        <d1p1:CodeTable CodeTableName="INFOSOURCECODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="EMAILADDRESSDONOTEMAIL" DataType="Boolean" Caption="Do not send email to this address" CaptionResourceKey="$$do_not_send_email_to_this_address" />
      <d1p1:FormField FieldID="EMAILADDRESSSTARTDATE" DataType="Date" Caption="Email address start date" CaptionResourceKey="$$email_address_start_date" />
      <d1p1:FormField FieldID="EMAILADDRESSENDDATE" DataType="Date" Caption="Email address end date" CaptionResourceKey="$$email_address_end_date" />
      <d1p1:FormField FieldID="EMAILADDRESSINFOSOURCECODEID" DataType="Guid" Caption="Info source" CaptionResourceKey="$$info_source">
        <d1p1:CodeTable CodeTableName="INFOSOURCECODE" />
      </d1p1:FormField>
      <d1p1:FormField FieldID="DEFAULTCOUNTRYID" DataType="Guid" ReadOnly="true" Caption="DEFAULTCOUNTRYID" CaptionResourceKey="$$defaultcountryid" />
      <d1p1:FormField FieldID="CONSTITUENCIES" DataType="XML" Hidden="true" Caption="Constituencies">
        <d1p1:Collection Serialization="Attribute">
          <d1p1:Fields>
            <d1p1:FormField FieldID="CONSTITUENCYCODEID" DataType="Guid" Caption="Constituency" CaptionResourceKey="$$constituency" />
            <d1p1:FormField FieldID="ORIGINALCONSTITUENCYID" DataType="Guid" Caption="Original constituency" CaptionResourceKey="$$original_constituency" />
            <d1p1:FormField FieldID="DATEFROM" DataType="Date" Caption="Date from" CaptionResourceKey="$$date_from" />
            <d1p1:FormField FieldID="DATETO" DataType="Date" Caption="Date to" CaptionResourceKey="$$date_to" />
          </d1p1:Fields>
        </d1p1:Collection>
      </d1p1:FormField>
    </d1p1:FormFields>
  </d1p1:FormMetaData>
</EditDataFormTemplateSpec>