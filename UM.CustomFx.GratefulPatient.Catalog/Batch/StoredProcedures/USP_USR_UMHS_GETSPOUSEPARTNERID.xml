<SQLStoredProcedureSpec
	xmlns="bb_appfx_sqlstoredprocedure"
	xmlns:c="bb_appfx_commontypes" 
	ID="344db3c3-83c5-41d6-a6b1-86e15e157963"
	Name="USP_USR_UMHS_GETSPOUSEPARTNERID"
	Description="Get the Spouse/Partner of an individual"
	Author="UM Dev"
	SPName="USP_USR_UMHS_GETSPOUSEPARTNERID"
	>

	<CreateProcedureSQL>
		<![CDATA[
create procedure dbo.USP_USR_UMHS_GETSPOUSEPARTNERID
(
	@CONSTITUENTID uniqueidentifier,
	@CONSTITUENTSPOUSEPARTNERID uniqueidentifier output
)
as
set nocount on;
begin

declare 
	@ONLYCURRENT bit = 0,
	@RECIPROCALTYPECODEID uniqueidentifier = null,
	@ONLYCONTACTS bit = 0,
	@SHOWINDIVIDUALS bit = 1,
	@SHOWORGANIZATIONS bit = 0,
	@SHOWGROUPS bit = 0,
	@SHOWHOUSEHOLDS bit = 1;

	declare @CURRENTDATE datetime
	if @ONLYCURRENT = 1
		set @CURRENTDATE = dbo.UFN_DATE_GETEARLIESTTIME(getdate());

	set @CONSTITUENTSPOUSEPARTNERID = NULL;

	select	
		@CONSTITUENTSPOUSEPARTNERID=RELATIONSHIP.RECIPROCALCONSTITUENTID
	from 
		dbo.RELATIONSHIP
		inner join RELATIONSHIPTYPECODE on RELATIONSHIPTYPECODE.ID=RELATIONSHIP.RELATIONSHIPTYPECODEID
		inner join dbo.CONSTITUENT on RELATIONSHIP.RECIPROCALCONSTITUENTID = CONSTITUENT.ID
		left join dbo.GROUPDATA on CONSTITUENT.ID = GROUPDATA.ID
		outer apply dbo.UFN_CONSTITUENT_DISPLAYNAME(CONSTITUENT.ID) NF
	where 
		RELATIONSHIP.RELATIONSHIPCONSTITUENTID = @CONSTITUENTID
		and (@CURRENTDATE is null
			or RELATIONSHIP.STARTDATE is null
			or RELATIONSHIP.STARTDATE <= @CURRENTDATE)
		and (@CURRENTDATE is null
			or RELATIONSHIP.ENDDATE is null
			or RELATIONSHIP.ENDDATE >= @CURRENTDATE)
		and (@RECIPROCALTYPECODEID is null
			or RELATIONSHIP.RECIPROCALTYPECODEID = @RECIPROCALTYPECODEID)
		and 
			(@ONLYCONTACTS = 0
			or RELATIONSHIP.ISCONTACT = @ONLYCONTACTS)
		and (@SHOWINDIVIDUALS = 1 or CONSTITUENT.ISORGANIZATION = 1 or CONSTITUENT.ISGROUP = 1)
		and (@SHOWORGANIZATIONS = 1 or CONSTITUENT.ISORGANIZATION = 0)
		and (@SHOWGROUPS = 1 or CONSTITUENT.ISGROUP = 0 or GROUPDATA.GROUPTYPECODE = 0)
		and (@SHOWHOUSEHOLDS = 1 or CONSTITUENT.ISGROUP = 0 or GROUPDATA.GROUPTYPECODE = 1)
		and RELATIONSHIPTYPECODE.[DESCRIPTION] in (N'Spouse/Partner')
		and RELATIONSHIP.ENDDATE IS NULL;
    
end
		]]>
	</CreateProcedureSQL>

</SQLStoredProcedureSpec>
